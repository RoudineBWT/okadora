#!/usr/bin/env bash
# Helper script to enable the performance profile with proton or others
# For Bazzite-based images using tuned profiles

# Check if tuned-adm is available
if ! command -v tuned-adm &>/dev/null; then
    echo "Error: tuned-adm not found" >&2
    exit 1
fi

# Don't fail if the profile doesn't exist, just run the command
if ! tuned-adm list | grep -q 'throughput-performance-bazzite'; then
    exec "$@"
fi

# Save the current profile before changing it
CURRENT_PROFILE=$(tuned-adm active | awk '{print $NF}')

# Function to restore profile on exit
restore_profile() {
    # If no profile was saved, default to balanced-bazzite
    tuned-adm profile "${CURRENT_PROFILE:-balanced-bazzite}" &>/dev/null
}

# Set trap to restore profile when script exits
trap restore_profile EXIT INT TERM

# Set performance profile and launch the game
tuned-adm profile throughput-performance-bazzite

# Launch the game with or without systemd-inhibit
if [ -n "$GAME_PERFORMANCE_SCREENSAVER_ON" ]; then
    "$@"
else
    systemd-inhibit --why "game-performance is running" -- "$@"
fi

# Store exit code to return it properly
EXIT_CODE=$?

# The trap will automatically restore the profile here

exit $EXIT_CODE